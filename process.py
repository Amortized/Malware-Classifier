import sys;
import glob;
from multiprocessing import Pool;
import time;
import gzip;

def readLabels(myfile):
  '''
    Generates a dict of labels
  '''
  labels = {};
  try :
    with open(myfile, "r") as f:
      next(f);
      for line in f:
        t = line.strip().split(',');
        labels[t[0].replace("\"", "")] = t[1];
  except :
    print("No files found ./data/");
    exit(1);
    
  return labels;
   
def genFeatures(myfile):
  '''
     Get the features
  '''
  try :
    lines = [line.strip().split()[1:] for line in open(myfile)]
  except :
    print("No files found ./data/");
    exit(1);

  features  = [0] * (16 ** 2 + 1);
  for line in lines:
    for record in line:
      #Count the byte occurence
      if record == '??':
        features[256] += 1;
      else:
        features[int(record,16)] += 1;
 
  return features;

def process(myfile, label):
  '''
     Generates signature and writes to a file
  '''

  features = genFeatures(myfile);


  with open(myfile+".features", "w") as f:
    for fr in features:
      f.write(str(fr) + ",");

    f.write(label);
    f.write("\n");
    f.close();
     

def process_wrapper(args):
  process(*args);


if __name__ == '__main__':

  bytes_files =  glob.glob("./data/train/*.bytes");
  label_file  =  "./data/trainLabels.csv";

  start = time.time();

  labels  = readLabels(label_file);
  pool    = Pool();

  try :
    params  = [(b_f, labels[b_f.replace(".bytes","").replace("./data/","")]) for b_f in bytes_files];
  except :
    pass

  results = pool.map( process_wrapper, params );

  pool.close();
  pool.join();

  print('total runtime = {0}'.format(time.time() - start));
